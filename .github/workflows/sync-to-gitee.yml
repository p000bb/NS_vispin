name: Sync to Gitee

on:
  # 代码推送时触发
  push:
    branches:
      - main
      - master
    tags:
      - "v*" # 同步标签

  # Release 发布时触发
  release:
    types: [published]

jobs:
  sync-code:
    name: Sync Code to Gitee
    runs-on: ubuntu-latest
    # 只在代码推送时执行
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史记录，包括标签

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITEE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Push to Gitee
        run: |
          git remote add gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git || true
          git remote set-url gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git

          # 推送所有分支和标签
          git push gitee --all --force
          git push gitee --tags --force

  sync-release:
    name: Sync Release to Gitee
    runs-on: ubuntu-latest
    # 只在 Release 发布时执行
    if: github.event_name == 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史记录，包括标签

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITEE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Sync code and tag to Gitee
        run: |
          git remote add gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git || true
          git remote set-url gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git

          # 获取当前分支名
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          
          # 推送代码到 main 或 master 分支（使用完全限定的引用名称）
          if git ls-remote --heads gitee main | grep -q .; then
            echo "推送到 main 分支"
            git push gitee HEAD:refs/heads/main --force
          elif git ls-remote --heads gitee master | grep -q .; then
            echo "推送到 master 分支"
            git push gitee HEAD:refs/heads/master --force
          else
            echo "Gitee 上不存在 main 或 master 分支，推送到 main"
            git push gitee HEAD:refs/heads/main --force
          fi
          
          # 推送标签（使用完全限定的引用名称）
          TAG_NAME="${{ github.event.release.tag_name }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "推送标签: $TAG_NAME"
            git push gitee refs/tags/${TAG_NAME}:refs/tags/${TAG_NAME} --force
          else
            echo "⚠️  标签 $TAG_NAME 不存在，跳过标签推送"
          fi

      - name: Create Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          TAG_NAME: ${{ github.event.release.tag_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          GITEE_OWNER: ${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}
          GITEE_REPO: ${{ secrets.GITEE_REPO || 'NS_vispin' }}
        run: |
          # 获取当前 commit hash（Gitee 需要 target_commitish）
          COMMIT_HASH=$(git rev-parse HEAD)

          # 创建 Release
          RELEASE_RESPONSE=$(curl -s -X POST \
            "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases?access_token=${GITEE_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "tag_name": "'"${TAG_NAME}"'",
              "name": "'"${RELEASE_NAME}"'",
              "body": "'"${RELEASE_BODY}"'",
              "target_commitish": "'"${COMMIT_HASH}"'",
              "prerelease": false
            }')

          # 提取 Release ID
          RELEASE_ID=$(echo $RELEASE_RESPONSE | grep -o '"id":[0-9]*' | grep -o '[0-9]*' | head -1)

          if [ -z "$RELEASE_ID" ]; then
            echo "⚠️  Release 可能已存在，尝试获取现有 Release..."
            RELEASE_RESPONSE=$(curl -s -X GET \
              "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/tags/${TAG_NAME}?access_token=${GITEE_TOKEN}")
            RELEASE_ID=$(echo $RELEASE_RESPONSE | grep -o '"id":[0-9]*' | grep -o '[0-9]*' | head -1)
          fi

          echo "RELEASE_ID=${RELEASE_ID}" >> $GITHUB_ENV
          echo "✅ Gitee Release 创建成功，ID: ${RELEASE_ID}"
          echo "📋 Release 响应: ${RELEASE_RESPONSE}"
          
          # 验证 Release ID 是否有效
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "❌ 警告: Release ID 无效，可能影响后续文件上传"
          fi

      - name: Upload Release Assets
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_OWNER: ${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}
          GITEE_REPO: ${{ secrets.GITEE_REPO || 'NS_vispin' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 从环境变量获取 Release ID
          RELEASE_ID="${RELEASE_ID}"
          
          echo "🔍 调试信息:"
          echo "  GITEE_OWNER: ${GITEE_OWNER}"
          echo "  GITEE_REPO: ${GITEE_REPO}"
          echo "  RELEASE_ID: ${RELEASE_ID}"
          
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "❌ 无法获取 Release ID，尝试重新获取..."
            TAG_NAME="${{ github.event.release.tag_name }}"
            RELEASE_RESPONSE=$(curl -s -X GET \
              "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/tags/${TAG_NAME}?access_token=${GITEE_TOKEN}")
            RELEASE_ID=$(echo "$RELEASE_RESPONSE" | grep -o '"id":[0-9]*' | grep -o '[0-9]*' | head -1)
            echo "  重新获取的 RELEASE_ID: ${RELEASE_ID}"
          fi
          
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "❌ 无法获取 Release ID，跳过文件上传"
            echo "📋 响应内容: ${RELEASE_RESPONSE}"
            exit 1
          fi

          echo "🔍 开始获取 GitHub Release assets..."
          
          # 方法1: 使用 GitHub API 通过 release ID 获取 assets
          RELEASE_ID_GITHUB="${{ github.event.release.id }}"
          ASSETS_JSON=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/${RELEASE_ID_GITHUB}/assets")
          
          # 如果失败，尝试通过 tag 获取
          if [ -z "$ASSETS_JSON" ] || echo "$ASSETS_JSON" | grep -q "Not Found"; then
            echo "⚠️  通过 release ID 获取失败，尝试通过 tag 获取..."
            TAG_NAME="${{ github.event.release.tag_name }}"
            RELEASE_INFO=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG_NAME}")
            RELEASE_ID_GITHUB=$(echo "$RELEASE_INFO" | grep -o '"id":[0-9]*' | head -1 | grep -o '[0-9]*')
            if [ -n "$RELEASE_ID_GITHUB" ]; then
              ASSETS_JSON=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/${RELEASE_ID_GITHUB}/assets")
            fi
          fi
          
          # 检查 assets 数量
          ASSETS_COUNT=$(echo "$ASSETS_JSON" | grep -o '"id"' | wc -l)
          echo "📦 找到 ${ASSETS_COUNT} 个 assets"
          
          if [ "$ASSETS_COUNT" -eq 0 ]; then
            echo "⚠️  未找到任何 assets，跳过上传"
            exit 0
          fi
          
          # 使用 jq 解析并上传每个 asset（GitHub Actions 默认包含 jq）
          echo "$ASSETS_JSON" | jq -r '.[] | "\(.browser_download_url)|\(.name)|\(.size)"' | while IFS='|' read -r ASSET_URL ASSET_NAME ASSET_SIZE; do
            if [ -n "$ASSET_URL" ] && [ -n "$ASSET_NAME" ]; then
              echo ""
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
              echo "📤 上传文件: ${ASSET_NAME} (大小: ${ASSET_SIZE} 字节)"
              
              # 下载文件
              echo "⬇️  正在下载: ${ASSET_URL}"
              curl -L -f -o /tmp/${ASSET_NAME} "${ASSET_URL}"
              
              if [ $? -ne 0 ]; then
                echo "❌ 下载失败: ${ASSET_NAME}"
                continue
              fi
              
              # 检查文件是否存在
              if [ ! -f "/tmp/${ASSET_NAME}" ]; then
                echo "❌ 文件不存在: /tmp/${ASSET_NAME}"
                continue
              fi
              
              FILE_SIZE=$(stat -f%z "/tmp/${ASSET_NAME}" 2>/dev/null || stat -c%s "/tmp/${ASSET_NAME}" 2>/dev/null || echo "unknown")
              echo "✅ 下载成功，文件大小: ${FILE_SIZE} 字节"
              
              # 上传到 Gitee - 使用 attach_files 端点（Gitee API v5 的正确端点）
              echo "⬆️  正在上传到 Gitee..."
              echo "   端点: https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${RELEASE_ID}/attach_files"
              
              UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${RELEASE_ID}/attach_files?access_token=${GITEE_TOKEN}" \
                -F "file=@/tmp/${ASSET_NAME}" \
                -F "name=${ASSET_NAME}")
              
              HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -1)
              RESPONSE_BODY=$(echo "$UPLOAD_RESPONSE" | head -n -1)
              
              echo "   HTTP 状态码: ${HTTP_CODE}"
              
              if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
                echo "✅ ${ASSET_NAME} 上传成功"
              elif echo "$RESPONSE_BODY" | grep -q '"id"'; then
                echo "✅ ${ASSET_NAME} 上传成功（通过响应内容判断）"
              else
                echo "❌ ${ASSET_NAME} 上传失败 (HTTP: ${HTTP_CODE})"
                echo "📋 响应内容: ${RESPONSE_BODY}"
                
                # 如果 404，尝试使用 assets 端点（备用方案）
                if [ "$HTTP_CODE" = "404" ]; then
                  echo "⚠️  尝试使用备用端点..."
                  UPLOAD_RESPONSE2=$(curl -s -w "\n%{http_code}" -X POST \
                    "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${RELEASE_ID}/assets?access_token=${GITEE_TOKEN}" \
                    -F "file=@/tmp/${ASSET_NAME}" \
                    -F "name=${ASSET_NAME}")
                  
                  HTTP_CODE2=$(echo "$UPLOAD_RESPONSE2" | tail -1)
                  RESPONSE_BODY2=$(echo "$UPLOAD_RESPONSE2" | head -n -1)
                  
                  if [ "$HTTP_CODE2" = "201" ] || [ "$HTTP_CODE2" = "200" ] || echo "$RESPONSE_BODY2" | grep -q '"id"'; then
                    echo "✅ ${ASSET_NAME} 上传成功（使用备用端点）"
                  else
                    echo "❌ 备用端点也失败 (HTTP: ${HTTP_CODE2})"
                    echo "📋 响应: ${RESPONSE_BODY2}"
                  fi
                fi
              fi
              
              # 清理临时文件
              rm -f /tmp/${ASSET_NAME}
            fi
          done
          
          echo ""
          echo "🎉 Assets 上传完成"
