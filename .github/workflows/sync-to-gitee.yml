name: Sync to Gitee

on:
  # ‰ª£Á†ÅÊé®ÈÄÅÊó∂Ëß¶Âèë
  push:
    branches:
      - main
      - master
    tags:
      - "v*" # ÂêåÊ≠•Ê†áÁ≠æ

  # Release ÂèëÂ∏ÉÊó∂Ëß¶Âèë
  release:
    types: [published]

jobs:
  sync-code:
    name: Sync Code to Gitee
    runs-on: ubuntu-latest
    # Âè™Âú®‰ª£Á†ÅÊé®ÈÄÅÊó∂ÊâßË°å
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤ËÆ∞ÂΩïÔºåÂåÖÊã¨Ê†áÁ≠æ

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITEE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Push to Gitee
        run: |
          git remote add gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git || true
          git remote set-url gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git

          # Êé®ÈÄÅÊâÄÊúâÂàÜÊîØÂíåÊ†áÁ≠æ
          git push gitee --all --force
          git push gitee --tags --force

  sync-release:
    name: Sync Release to Gitee
    runs-on: ubuntu-latest
    # Âè™Âú® Release ÂèëÂ∏ÉÊó∂ÊâßË°å
    if: github.event_name == 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤ËÆ∞ÂΩïÔºåÂåÖÊã¨Ê†áÁ≠æ

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITEE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Sync code and tag to Gitee
        run: |
          git remote add gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git || true
          git remote set-url gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git

          # Ëé∑ÂèñÂΩìÂâçÂàÜÊîØÂêç
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          
          # Êé®ÈÄÅ‰ª£Á†ÅÂà∞ main Êàñ master ÂàÜÊîØÔºà‰ΩøÁî®ÂÆåÂÖ®ÈôêÂÆöÁöÑÂºïÁî®ÂêçÁß∞Ôºâ
          if git ls-remote --heads gitee main | grep -q .; then
            echo "Êé®ÈÄÅÂà∞ main ÂàÜÊîØ"
            git push gitee HEAD:refs/heads/main --force
          elif git ls-remote --heads gitee master | grep -q .; then
            echo "Êé®ÈÄÅÂà∞ master ÂàÜÊîØ"
            git push gitee HEAD:refs/heads/master --force
          else
            echo "Gitee ‰∏ä‰∏çÂ≠òÂú® main Êàñ master ÂàÜÊîØÔºåÊé®ÈÄÅÂà∞ main"
            git push gitee HEAD:refs/heads/main --force
          fi
          
          # Êé®ÈÄÅÊ†áÁ≠æÔºà‰ΩøÁî®ÂÆåÂÖ®ÈôêÂÆöÁöÑÂºïÁî®ÂêçÁß∞Ôºâ
          TAG_NAME="${{ github.event.release.tag_name }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Êé®ÈÄÅÊ†áÁ≠æ: $TAG_NAME"
            git push gitee refs/tags/${TAG_NAME}:refs/tags/${TAG_NAME} --force
          else
            echo "‚ö†Ô∏è  Ê†áÁ≠æ $TAG_NAME ‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÊ†áÁ≠æÊé®ÈÄÅ"
          fi

      - name: Create Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          TAG_NAME: ${{ github.event.release.tag_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          GITEE_OWNER: ${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}
          GITEE_REPO: ${{ secrets.GITEE_REPO || 'NS_vispin' }}
        run: |
          # Ëé∑ÂèñÂΩìÂâç commit hashÔºàGitee ÈúÄË¶Å target_commitishÔºâ
          COMMIT_HASH=$(git rev-parse HEAD)

          # ÂàõÂª∫ Release
          RELEASE_RESPONSE=$(curl -s -X POST \
            "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases?access_token=${GITEE_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "tag_name": "'"${TAG_NAME}"'",
              "name": "'"${RELEASE_NAME}"'",
              "body": "'"${RELEASE_BODY}"'",
              "target_commitish": "'"${COMMIT_HASH}"'",
              "prerelease": false
            }')

          # ÊèêÂèñ Release ID
          RELEASE_ID=$(echo $RELEASE_RESPONSE | grep -o '"id":[0-9]*' | grep -o '[0-9]*' | head -1)

          if [ -z "$RELEASE_ID" ]; then
            echo "‚ö†Ô∏è  Release ÂèØËÉΩÂ∑≤Â≠òÂú®ÔºåÂ∞ùËØïËé∑ÂèñÁé∞Êúâ Release..."
            RELEASE_RESPONSE=$(curl -s -X GET \
              "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/tags/${TAG_NAME}?access_token=${GITEE_TOKEN}")
            RELEASE_ID=$(echo $RELEASE_RESPONSE | grep -o '"id":[0-9]*' | grep -o '[0-9]*' | head -1)
          fi

          echo "RELEASE_ID=${RELEASE_ID}" >> $GITHUB_ENV
          echo "‚úÖ Gitee Release ÂàõÂª∫ÊàêÂäüÔºåID: ${RELEASE_ID}"

      - name: Upload Release Assets
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_OWNER: ${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}
          GITEE_REPO: ${{ secrets.GITEE_REPO || 'NS_vispin' }}
        run: |
          if [ -z "$RELEASE_ID" ]; then
            echo "‚ùå Êó†Ê≥ïËé∑Âèñ Release IDÔºåË∑≥ËøáÊñá‰ª∂‰∏ä‰º†"
            exit 0
          fi

          # ‰∏ä‰º† GitHub Release ‰∏≠ÁöÑÊØè‰∏™Êñá‰ª∂
          for asset in ${{ toJSON(github.event.release.assets) }}; do
            ASSET_URL=$(echo $asset | grep -o '"browser_download_url":"[^"]*"' | cut -d'"' -f4)
            ASSET_NAME=$(echo $asset | grep -o '"name":"[^"]*"' | cut -d'"' -f4)
            
            if [ -n "$ASSET_URL" ] && [ -n "$ASSET_NAME" ]; then
              echo "üì§ ‰∏ä‰º†Êñá‰ª∂: ${ASSET_NAME}"
              
              # ‰∏ãËΩΩÊñá‰ª∂
              curl -L -o /tmp/${ASSET_NAME} "${ASSET_URL}"
              
              # ‰∏ä‰º†Âà∞ Gitee
              curl -X POST \
                "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${RELEASE_ID}/assets?access_token=${GITEE_TOKEN}" \
                -F "file=@/tmp/${ASSET_NAME}" \
                -F "name=${ASSET_NAME}"
              
              echo "‚úÖ ${ASSET_NAME} ‰∏ä‰º†ÊàêÂäü"
            fi
          done
