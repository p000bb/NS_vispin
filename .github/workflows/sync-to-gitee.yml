name: Sync to Gitee

on:
  # ä»£ç æ¨é€æ—¶è§¦å‘
  push:
    branches:
      - main
      - master
    tags:
      - "v*" # åŒæ­¥æ ‡ç­¾

  # Release å‘å¸ƒæ—¶è§¦å‘
  release:
    types: [published]

jobs:
  sync-code:
    name: Sync Code to Gitee
    runs-on: ubuntu-latest
    # åªåœ¨ä»£ç æ¨é€æ—¶æ‰§è¡Œ
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ï¼ŒåŒ…æ‹¬æ ‡ç­¾

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITEE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Push to Gitee
        run: |
          git remote add gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git || true
          git remote set-url gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git

          # æ¨é€æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾
          git push gitee --all --force
          git push gitee --tags --force

  sync-release:
    name: Sync Release to Gitee
    runs-on: ubuntu-latest
    # åªåœ¨ Release å‘å¸ƒæ—¶æ‰§è¡Œ
    if: github.event_name == 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ï¼ŒåŒ…æ‹¬æ ‡ç­¾

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITEE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Sync code and tag to Gitee
        run: |
          git remote add gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git || true
          git remote set-url gitee git@gitee.com:${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}/${{ secrets.GITEE_REPO || 'NS_vispin' }}.git

          # è·å–å½“å‰åˆ†æ”¯å
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          
          # æ¨é€ä»£ç åˆ° main æˆ– master åˆ†æ”¯ï¼ˆä½¿ç”¨å®Œå…¨é™å®šçš„å¼•ç”¨åç§°ï¼‰
          if git ls-remote --heads gitee main | grep -q .; then
            echo "æ¨é€åˆ° main åˆ†æ”¯"
            git push gitee HEAD:refs/heads/main --force
          elif git ls-remote --heads gitee master | grep -q .; then
            echo "æ¨é€åˆ° master åˆ†æ”¯"
            git push gitee HEAD:refs/heads/master --force
          else
            echo "Gitee ä¸Šä¸å­˜åœ¨ main æˆ– master åˆ†æ”¯ï¼Œæ¨é€åˆ° main"
            git push gitee HEAD:refs/heads/main --force
          fi
          
          # æ¨é€æ ‡ç­¾ï¼ˆä½¿ç”¨å®Œå…¨é™å®šçš„å¼•ç”¨åç§°ï¼‰
          TAG_NAME="${{ github.event.release.tag_name }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "æ¨é€æ ‡ç­¾: $TAG_NAME"
            git push gitee refs/tags/${TAG_NAME}:refs/tags/${TAG_NAME} --force
          else
            echo "âš ï¸  æ ‡ç­¾ $TAG_NAME ä¸å­˜åœ¨ï¼Œè·³è¿‡æ ‡ç­¾æ¨é€"
          fi

      - name: Create Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          TAG_NAME: ${{ github.event.release.tag_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          GITEE_OWNER: ${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}
          GITEE_REPO: ${{ secrets.GITEE_REPO || 'NS_vispin' }}
        run: |
          # è·å–å½“å‰ commit hashï¼ˆGitee éœ€è¦ target_commitishï¼‰
          COMMIT_HASH=$(git rev-parse HEAD)

          # åˆ›å»º Release
          RELEASE_RESPONSE=$(curl -s -X POST \
            "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases?access_token=${GITEE_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "tag_name": "'"${TAG_NAME}"'",
              "name": "'"${RELEASE_NAME}"'",
              "body": "'"${RELEASE_BODY}"'",
              "target_commitish": "'"${COMMIT_HASH}"'",
              "prerelease": false
            }')

          # æå– Release ID
          RELEASE_ID=$(echo $RELEASE_RESPONSE | grep -o '"id":[0-9]*' | grep -o '[0-9]*' | head -1)

          if [ -z "$RELEASE_ID" ]; then
            echo "âš ï¸  Release å¯èƒ½å·²å­˜åœ¨ï¼Œå°è¯•è·å–ç°æœ‰ Release..."
            RELEASE_RESPONSE=$(curl -s -X GET \
              "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/tags/${TAG_NAME}?access_token=${GITEE_TOKEN}")
            RELEASE_ID=$(echo $RELEASE_RESPONSE | grep -o '"id":[0-9]*' | grep -o '[0-9]*' | head -1)
          fi

          echo "RELEASE_ID=${RELEASE_ID}" >> $GITHUB_ENV
          echo "âœ… Gitee Release åˆ›å»ºæˆåŠŸï¼ŒID: ${RELEASE_ID}"

      - name: Upload Release Assets
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_OWNER: ${{ secrets.GITEE_USERNAME || 'xiong_ying001' }}
          GITEE_REPO: ${{ secrets.GITEE_REPO || 'NS_vispin' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$RELEASE_ID" ]; then
            echo "âŒ æ— æ³•è·å– Release IDï¼Œè·³è¿‡æ–‡ä»¶ä¸Šä¼ "
            exit 0
          fi

          echo "ğŸ” å¼€å§‹è·å– GitHub Release assets..."
          
          # æ–¹æ³•1: ä½¿ç”¨ GitHub API é€šè¿‡ release ID è·å– assets
          RELEASE_ID_GITHUB="${{ github.event.release.id }}"
          ASSETS_JSON=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/${RELEASE_ID_GITHUB}/assets")
          
          # å¦‚æœå¤±è´¥ï¼Œå°è¯•é€šè¿‡ tag è·å–
          if [ -z "$ASSETS_JSON" ] || echo "$ASSETS_JSON" | grep -q "Not Found"; then
            echo "âš ï¸  é€šè¿‡ release ID è·å–å¤±è´¥ï¼Œå°è¯•é€šè¿‡ tag è·å–..."
            TAG_NAME="${{ github.event.release.tag_name }}"
            RELEASE_INFO=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG_NAME}")
            RELEASE_ID_GITHUB=$(echo "$RELEASE_INFO" | grep -o '"id":[0-9]*' | head -1 | grep -o '[0-9]*')
            if [ -n "$RELEASE_ID_GITHUB" ]; then
              ASSETS_JSON=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/${RELEASE_ID_GITHUB}/assets")
            fi
          fi
          
          # æ£€æŸ¥ assets æ•°é‡
          ASSETS_COUNT=$(echo "$ASSETS_JSON" | grep -o '"id"' | wc -l)
          echo "ğŸ“¦ æ‰¾åˆ° ${ASSETS_COUNT} ä¸ª assets"
          
          if [ "$ASSETS_COUNT" -eq 0 ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°ä»»ä½• assetsï¼Œè·³è¿‡ä¸Šä¼ "
            exit 0
          fi
          
          # ä½¿ç”¨ jq è§£æå¹¶ä¸Šä¼ æ¯ä¸ª assetï¼ˆGitHub Actions é»˜è®¤åŒ…å« jqï¼‰
          echo "$ASSETS_JSON" | jq -r '.[] | "\(.browser_download_url)|\(.name)|\(.size)"' | while IFS='|' read -r ASSET_URL ASSET_NAME ASSET_SIZE; do
            if [ -n "$ASSET_URL" ] && [ -n "$ASSET_NAME" ]; then
              echo "ğŸ“¤ ä¸Šä¼ æ–‡ä»¶: ${ASSET_NAME} (å¤§å°: ${ASSET_SIZE} å­—èŠ‚)"
              
              # ä¸‹è½½æ–‡ä»¶
              echo "â¬‡ï¸  æ­£åœ¨ä¸‹è½½: ${ASSET_URL}"
              curl -L -f -o /tmp/${ASSET_NAME} "${ASSET_URL}"
              
              if [ $? -ne 0 ]; then
                echo "âŒ ä¸‹è½½å¤±è´¥: ${ASSET_NAME}"
                continue
              fi
              
              # ä¸Šä¼ åˆ° Gitee
              echo "â¬†ï¸  æ­£åœ¨ä¸Šä¼ åˆ° Gitee..."
              UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${RELEASE_ID}/assets?access_token=${GITEE_TOKEN}" \
                -F "file=@/tmp/${ASSET_NAME}" \
                -F "name=${ASSET_NAME}")
              
              HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -1)
              RESPONSE_BODY=$(echo "$UPLOAD_RESPONSE" | head -n -1)
              
              if [ "$HTTP_CODE" = "201" ] || echo "$RESPONSE_BODY" | grep -q '"id"'; then
                echo "âœ… ${ASSET_NAME} ä¸Šä¼ æˆåŠŸ"
              else
                echo "âŒ ${ASSET_NAME} ä¸Šä¼ å¤±è´¥ (HTTP: ${HTTP_CODE})"
                echo "å“åº”: ${RESPONSE_BODY}"
              fi
              
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -f /tmp/${ASSET_NAME}
            fi
          done
          
          echo "ğŸ‰ Assets ä¸Šä¼ å®Œæˆ"
